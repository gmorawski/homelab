# Playbook pour d√©sinstaller compl√®tement Mealie

- name: D√©sinstallation compl√®te de Mealie
  hosts: webservers
  become: yes
  vars:
    mealie_user: "mealie"
    mealie_home: "/opt/mealie"
    mealie_data: "/var/lib/mealie"
    site_name: "mealie"
    
  tasks:
    # Confirmation avant d√©sinstallation
    - name: Confirmation de la d√©sinstallation
      pause:
        prompt: |
          ‚ö†Ô∏è  ATTENTION: Cette op√©ration va supprimer compl√®tement Mealie et ses donn√©es.
          
          √âl√©ments qui seront supprim√©s:
          - Application Mealie ({{ mealie_home }})
          - Donn√©es et recettes ({{ mealie_data }})
          - Configurations Apache
          - Utilisateur syst√®me
          - Services et crons
          
          Tapez 'yes' pour confirmer la d√©sinstallation
      register: confirmation
      
    - name: V√©rification de la confirmation
      fail:
        msg: "D√©sinstallation annul√©e par l'utilisateur"
      when: confirmation.user_input != "yes"

    # Sauvegarde de s√©curit√© avant suppression
    - name: Cr√©ation d'une sauvegarde finale
      archive:
        path: "{{ mealie_data }}"
        dest: "/tmp/mealie_final_backup_{{ ansible_date_time.epoch }}.tar.gz"
        owner: root
        group: root
        mode: '0600'
      when: mealie_data is exists
      ignore_errors: yes

    # Arr√™t des services
    - name: Arr√™t du service Mealie
      systemd:
        name: mealie
        state: stopped
        enabled: no
      ignore_errors: yes

    - name: Arr√™t des conteneurs Docker
      command: docker-compose down -v
      args:
        chdir: "{{ mealie_home }}"
      become_user: "{{ mealie_user }}"
      ignore_errors: yes

    # Suppression des sites Apache
    - name: D√©sactivation des sites Apache
      command: "a2dissite {{ item }}"
      loop:
        - mealie-http
        - mealie-https
      ignore_errors: yes
      notify: reload apache

    - name: Suppression des configurations Apache
      file:
        path: "/etc/apache2/sites-available/{{ item }}"
        state: absent
      loop:
        - mealie-http.conf
        - mealie-https.conf
      notify: reload apache

    # Suppression du service systemd
    - name: Suppression du service systemd
      file:
        path: /etc/systemd/system/mealie.service
        state: absent
      notify: reload systemd

    # Suppression des t√¢ches cron
    - name: Suppression des t√¢ches cron
      cron:
        name: "{{ item }}"
        state: absent
        user: root
      loop:
        - "Sauvegarde Mealie"
        - "Backup Mealie"
      ignore_errors: yes

    # Suppression des scripts
    - name: Suppression des scripts de maintenance
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /usr/local/bin/backup-mealie.sh
        - /usr/local/bin/deploy-mealie.sh
        - /usr/local/bin/restore-mealie.sh
        - /opt/webhook-mealie.py

    # Suppression des certificats SSL sp√©cifiques
    - name: Suppression des certificats SSL Mealie
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/ssl/certs/mealie.crt
        - /etc/ssl/private/mealie.key

    # Suppression des donn√©es et r√©pertoires
    - name: Suppression des r√©pertoires Mealie
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ mealie_home }}"
        - "{{ mealie_data }}"

    # Suppression de l'utilisateur syst√®me
    - name: Suppression de l'utilisateur Mealie
      user:
        name: "{{ mealie_user }}"
        state: absent
        remove: yes

    # Nettoyage Docker (optionnel)
    - name: Suppression des images Docker Mealie
      docker_image:
        name: "ghcr.io/mealie-recipes/mealie"
        state: absent
        force_absent: yes
      ignore_errors: yes

    - name: Nettoyage des volumes Docker orphelins
      command: docker volume prune -f
      ignore_errors: yes

    # Nettoyage des paquets (optionnel et prudent)
    - name: Liste des paquets install√©s sp√©cifiquement pour Mealie
      debug:
        msg: |
          Les paquets suivants ont √©t√© install√©s pour Mealie mais ne seront pas supprim√©s
          automatiquement car ils peuvent √™tre utilis√©s par d'autres applications:
          - docker.io, docker-compose
          - postgresql, postgresql-contrib
          - nodejs, npm
          - python3-pip, supervisor
          
          Pour les supprimer manuellement (si non utilis√©s ailleurs):
          sudo apt remove docker.io docker-compose postgresql postgresql-contrib
          sudo apt autoremove

    # Informations finales
    - name: Informations de d√©sinstallation
      debug:
        msg: |
          ‚úÖ D√©sinstallation de Mealie termin√©e !
          
          üìÅ Sauvegarde finale cr√©√©e: /tmp/mealie_final_backup_{{ ansible_date_time.epoch }}.tar.gz
          üóëÔ∏è  R√©pertoires supprim√©s: {{ mealie_home }}, {{ mealie_data }}
          üë§ Utilisateur supprim√©: {{ mealie_user }}
          üåê Configurations Apache supprim√©es
          üîß Services et crons supprim√©s
          
          ‚ö†Ô∏è  Note: Les paquets syst√®me (Docker, PostgreSQL, etc.) n'ont pas √©t√© supprim√©s
          car ils peuvent √™tre utilis√©s par d'autres applications.

  handlers:
    - name: reload apache
      systemd:
        name: apache2
        state: reloaded

    - name: reload systemd
      systemd:
        daemon_reload: yes
