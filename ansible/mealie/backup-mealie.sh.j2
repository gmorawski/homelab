# Script de sauvegarde pour Mealie

#!/bin/bash
set -e

# Configuration
BACKUP_DIR="{{ mealie_data }}/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="mealie_backup_$DATE.tar.gz"
MEALIE_HOME="{{ mealie_home }}"
MEALIE_DATA="{{ mealie_data }}"
MAX_BACKUPS=7

echo "=== Sauvegarde Mealie - $DATE ==="

# Cr√©ation du r√©pertoire de sauvegarde
mkdir -p $BACKUP_DIR

# Arr√™t de Mealie pour assurer la coh√©rence
echo "Arr√™t temporaire de Mealie..."
cd $MEALIE_HOME
sudo -u {{ mealie_user }} docker-compose stop

# Cr√©ation de l'archive
echo "Cr√©ation de la sauvegarde..."
tar -czf $BACKUP_DIR/$BACKUP_FILE \
    -C {{ mealie_data }} \
    --exclude=backups \
    .

# Red√©marrage de Mealie
echo "Red√©marrage de Mealie..."
sudo -u {{ mealie_user }} docker-compose start

# Nettoyage des anciennes sauvegardes
echo "Nettoyage des anciennes sauvegardes..."
cd $BACKUP_DIR
ls -t mealie_backup_*.tar.gz | tail -n +$((MAX_BACKUPS + 1)) | xargs -r rm

# Informations finales
BACKUP_SIZE=$(du -h $BACKUP_DIR/$BACKUP_FILE | cut -f1)
echo "‚úÖ Sauvegarde termin√©e: $BACKUP_FILE ($BACKUP_SIZE)"
echo "üìÅ Emplacement: $BACKUP_DIR"
echo "üóÇÔ∏è  Sauvegardes disponibles:"
ls -lah $BACKUP_DIR/mealie_backup_*.tar.gz 2>/dev/null || echo "Aucune sauvegarde trouv√©e"
