# Script de restauration pour Mealie

#!/bin/bash
set -e

if [ $# -eq 0 ]; then
    echo "Usage: $0 <fichier_de_sauvegarde>"
    echo "Fichiers disponibles:"
    ls -la {{ mealie_data }}/backups/mealie_backup_*.tar.gz 2>/dev/null || echo "Aucune sauvegarde trouv√©e"
    exit 1
fi

BACKUP_FILE=$1
MEALIE_HOME="{{ mealie_home }}"
MEALIE_DATA="{{ mealie_data }}"

echo "=== Restauration Mealie ==="
echo "Fichier: $BACKUP_FILE"
echo ""

read -p "‚ö†Ô∏è  Cette op√©ration va √©craser les donn√©es actuelles. Continuer? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Restauration annul√©e."
    exit 1
fi

# Arr√™t de Mealie
echo "Arr√™t de Mealie..."
cd $MEALIE_HOME
sudo -u {{ mealie_user }} docker-compose stop

# Sauvegarde de s√©curit√©
echo "Cr√©ation d'une sauvegarde de s√©curit√©..."
SAFETY_BACKUP="safety_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
tar -czf $MEALIE_DATA/backups/$SAFETY_BACKUP -C $MEALIE_DATA --exclude=backups .

# Restauration
echo "Restauration en cours..."
cd $MEALIE_DATA
find . -maxdepth 1 -not -name 'backups' -not -name '.' -exec rm -rf {} +
tar -xzf $BACKUP_FILE -C $MEALIE_DATA

# Restauration des permissions
chown -R {{ mealie_user }}:{{ mealie_user }} $MEALIE_DATA

# Red√©marrage
echo "Red√©marrage de Mealie..."
cd $MEALIE_HOME
sudo -u {{ mealie_user }} docker-compose start

echo "‚úÖ Restauration termin√©e!"
echo "üíæ Sauvegarde de s√©curit√©: $SAFETY_BACKUP"